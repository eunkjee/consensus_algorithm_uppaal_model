<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>const int N = 4;
typedef int[0, N-1] n_id;

const int block_size = 100000;

const int INF = 100000;

//states
const int state_propose = 0
const int state_prevote = 1
const int state_prevote_wait = 11
const int state_precommit = 2
const int state_precommit_wait = 22
const int state_commit = 3

//Node struct
typedef struct{
    int last_block_height;
}TDsync;

typedef struct{
    int address;
    int voting_power;
    int proposer_priority;
}TDvalidator;

typedef struct{
    int id;
    TDsync Sync;
    TDvalidator validator;
}Node;

//Block struct
typedef struct{
    int block_id;
    int[0, INF] height;
    int last_block_id;
}TDheader;

typedef struct{
    int type;
    int[0, INF] height;
    int[0, INF] Round;
    int block_id;
    TDvalidator signatures[N];
}TDcommit;

typedef struct {
    TDheader header;
    int data;
    TDcommit Commit;
    bool is_locked;
}TDblock;

//BlockChain
typedef struct {
    int[0, N] last_height;
    TDblock index[block_size]; 
}BlockChain;

</declaration>
	<template>
		<name x="5" y="5">NodeChain</name>
		<declaration>// Place local declarations here.</declaration>
		<location id="id0" x="-313" y="60">
			<name x="-330" y="77">Start</name>
		</location>
		<location id="id1" x="-76" y="60">
			<name x="-110" y="77">ChainStart</name>
		</location>
		<location id="id2" x="-76" y="-161">
			<name x="-101" y="-195">ChainEnd</name>
		</location>
		<init ref="id0"/>
		<transition>
			<source ref="id2"/>
			<target ref="id1"/>
			<nail x="171" y="-161"/>
			<nail x="171" y="60"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id1"/>
		</transition>
	</template>
	<template>
		<name>NodeCss</name>
		<location id="id3" x="-816" y="331">
			<name x="-841" y="348">CssStart</name>
		</location>
		<location id="id4" x="-816" y="153">
			<name x="-892" y="144">Propose</name>
		</location>
		<location id="id5" x="-493" y="153">
			<name x="-484" y="161">Wait</name>
		</location>
		<location id="id6" x="-493" y="-34">
			<name x="-527" y="-68">PreCommit</name>
		</location>
		<location id="id7" x="-493" y="340">
			<name x="-518" y="357">PreVote</name>
		</location>
		<location id="id8" x="-297" y="153">
			<name x="-314" y="170">Commit</name>
		</location>
		<init ref="id3"/>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<nail x="-654" y="255"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id4"/>
			<nail x="-297" y="-34"/>
			<nail x="-816" y="-34"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id8"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id5"/>
			<nail x="-654" y="-34"/>
			<nail x="-654" y="153"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id5"/>
			<nail x="-654" y="340"/>
			<nail x="-654" y="153"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id7"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id6"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id5"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id4"/>
		</transition>
	</template>
	<system>system NodeChain, NodeCss;</system>
	<queries>
		<query>
			<formula></formula>
			<comment></comment>
		</query>
	</queries>
</nta>
